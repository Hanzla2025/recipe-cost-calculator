<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Cost Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff7e5f;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--secondary);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .delete-btn {
            flex: 0 0 40px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .summary-card p {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .new-ingredient-form {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .new-ingredient-form h3 {
            margin-bottom: 15px;
        }
        
        .new-ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .new-ingredient-row > * {
            flex: 1;
        }
        
        .csv-import-section {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .csv-import-section h3 {
            margin-bottom: 15px;
        }
        
        .csv-preview {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }
        
        .currency-symbol {
            font-weight: bold;
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .ingredient-row, .new-ingredient-row {
                flex-direction: column;
            }
            
            .charts-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LABAN Recipe Cost Calculator <span class="currency-symbol"></span></h1>
        
        <!-- Section 1: Recipe Name and Serving Size -->
        <div class="section">
            <h2>Recipe Information</h2>
            <div class="form-group">
                <label for="recipe-name">Recipe Name</label>
                <input type="text" id="recipe-name" placeholder="Enter recipe name">
            </div>
            <div class="form-group">
                <label for="serving-grams">Serving Size (grams)</label>
                <input type="number" id="serving-grams" placeholder="Enter serving size in grams">
            </div>
        </div>
        
        <!-- Section 2: Ingredient Selection -->
        <div class="section">
            <h2>Ingredients</h2>
            
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter">
                    <option value="all">All Categories</option>
                    <!-- Categories will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="ingredient-select">Select Ingredient</label>
                <select id="ingredient-select">
                    <option value="">-- Select an ingredient --</option>
                    <!-- Ingredients will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="form-group">
                <button id="add-ingredient-btn" class="btn-secondary">Add Selected Ingredient</button>
            </div>
            
            <div class="form-group">
                <button id="toggle-new-ingredient-form">+ Add New Ingredient</button>
            </div>
            
            <!-- New Ingredient Form -->
            <div id="new-ingredient-form" class="new-ingredient-form hidden">
                <h3>Add New Ingredient</h3>
                <div class="new-ingredient-row">
                    <input type="text" id="new-ingredient-name" placeholder="Ingredient Name">
                    <input type="number" id="new-ingredient-price" placeholder="Purchase Price (PKR)">
                    <input type="number" id="new-ingredient-weight" placeholder="Package Weight (g)">
                </div>
                <div class="new-ingredient-row">
                    <input type="text" id="new-ingredient-category" placeholder="Category">
                    <button id="save-new-ingredient" class="btn-success">Save New Ingredient</button>
                </div>
            </div>
            
            <!-- CSV Import Section -->
            <div class="csv-import-section">
                <h3>Import Ingredients from CSV</h3>
                <div class="form-group">
                    <label for="csv-file">Select CSV File</label>
                    <input type="file" id="csv-file" accept=".csv">
                </div>
                <div class="form-group">
                    <button id="import-csv-btn" class="btn-warning">Import CSV Data</button>
                </div>
                <div id="csv-preview" class="csv-preview hidden">
                    <h4>CSV Preview</h4>
                    <table id="preview-table">
                        <!-- Preview will be populated by JavaScript -->
                    </table>
                </div>
            </div>
            
            <!-- Selected Ingredients Table -->
            <table id="selected-ingredients">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Purchase Price (PKR)</th>
                        <th>Package Weight (g)</th>
                        <th>Per Gram Price (PKR)</th>
                        <th>Required Weight (g)</th>
                        <th>Cost (PKR)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Selected ingredients will be added here -->
                </tbody>
            </table>
        </div>
        
        <!-- Section 3: Cost Calculation and Analysis -->
        <div class="section">
            <h2>Cost Analysis</h2>
            
            <div class="summary">
                <div class="summary-card">
                    <h3>Total Recipe Cost</h3>
                    <p id="total-cost">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Cost Per Gram</h3>
                    <p id="per-gram-cost">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Cost Per Serving</h3>
                    <p id="per-serving-cost">PKR 0.00</p>
                </div>
            </div>
            
            <div class="form-group">
                <label for="margin-percentage">Desired Margin Percentage</label>
                <input type="number" id="margin-percentage" placeholder="Enter margin percentage" value="30">
            </div>
            
            <div class="summary">
                <div class="summary-card">
                    <h3>Selling Price</h3>
                    <p id="selling-price">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Profit Per Serving</h3>
                    <p id="profit-per-serving">PKR 0.00</p>
                </div>
            </div>
            
            <div class="form-group">
                <button id="calculate-btn" class="btn-success">Calculate Costs</button>
            </div>
        </div>
        
        <!-- Section 4: Visualization -->
        <div class="section">
            <h2>Recipe Breakdown</h2>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="cost-breakdown-chart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="weight-breakdown-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Section 5: Export -->
        <div class="section">
            <h2>Export Recipe</h2>
            <button id="export-pdf-btn" class="btn-secondary">Download PDF Report</button>
            <div class="form-group" style="margin-top: 15px;">
                <button id="export-csv-btn" class="btn-secondary">Export Ingredients to CSV</button>
            </div>
        </div>
    </div>

    <script>
        // Ingredient data from the CSV
        let ingredientData = [
            {ingredient: "flour", purchasePrice: 6400, packageWeight: 50000, category: "Dry Goods"},
            {ingredient: "semolina", purchasePrice: 180, packageWeight: 1000, category: "Dry Goods"},
            {ingredient: "granulated sugar", purchasePrice: 10200, packageWeight: 50000, category: "Sweeteners"},
            {ingredient: "packet brown sugar", purchasePrice: 450, packageWeight: 800, category: "Sweeteners"},
            {ingredient: "open brown sugar", purchasePrice: 250, packageWeight: 1000, category: "Sweeteners"},
            {ingredient: "open icing sugar", purchasePrice: 200, packageWeight: 1000, category: "Sweeteners"},
            {ingredient: "packet icing sugar", purchasePrice: 490, packageWeight: 800, category: "Sweeteners"},
            {ingredient: "honey", purchasePrice: 2500, packageWeight: 1000, category: "Sweeteners"},
            {ingredient: "glucose", purchasePrice: 450, packageWeight: 1000, category: "Sweeteners"},
            {ingredient: "blanco butter", purchasePrice: 950, packageWeight: 1000, category: "Dairy"},
            {ingredient: "faisalabad butter", purchasePrice: 1680, packageWeight: 1000, category: "Dairy"},
            {ingredient: "fauji oil", purchasePrice: 7650, packageWeight: 16000, category: "Fats & Oils"},
            {ingredient: "meezan oil", purchasePrice: 7800, packageWeight: 16000, category: "Fats & Oils"},
            {ingredient: "sofi ghee", purchasePrice: 9300, packageWeight: 16000, category: "Fats & Oils"},
            {ingredient: "khoya", purchasePrice: 1450, packageWeight: 1000, category: "Dairy"},
            {ingredient: "olpers milk", purchasePrice: 4000, packageWeight: 12000, category: "Dairy"},
            {ingredient: "milkfield milk", purchasePrice: 3360, packageWeight: 12000, category: "Dairy"},
            {ingredient: "asli milk", purchasePrice: 3300, packageWeight: 12000, category: "Dairy"},
            {ingredient: "condensed milk", purchasePrice: 12720, packageWeight: 24000, category: "Dairy"},
            {ingredient: "evaporated", purchasePrice: 16800, packageWeight: 18720, category: "Dairy"},
            {ingredient: "master-chef whipping cream", purchasePrice: 350, packageWeight: 350, category: "Dairy"},
            {ingredient: "youngs whipping cream", purchasePrice: 540, packageWeight: 550, category: "Dairy"},
            {ingredient: "whipy whip whipping cream", purchasePrice: 7600, packageWeight: 12000, category: "Dairy"},
            {ingredient: "silver whipping cream", purchasePrice: 18000, packageWeight: 12000, category: "Dairy"},
            {ingredient: "blanco whipping cream", purchasePrice: 6600, packageWeight: 12000, category: "Dairy"},
            {ingredient: "milkfield heavy-cream", purchasePrice: 4600, packageWeight: 4800, category: "Dairy"},
            {ingredient: "creamym heavy-cream", purchasePrice: 3800, packageWeight: 4800, category: "Dairy"},
            {ingredient: "omang dobala heavy-cream", purchasePrice: 3700, packageWeight: 4800, category: "Dairy"},
            {ingredient: "yougurt", purchasePrice: 260, packageWeight: 1000, category: "Dairy"},
            {ingredient: "whole eggs", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
            {ingredient: "eggs yolk", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
            {ingredient: "eggs white", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
            {ingredient: "baking powder", purchasePrice: 1800, packageWeight: 4400, category: "Leavening Agents"},
            {ingredient: "baking soda", purchasePrice: 200, packageWeight: 1000, category: "Leavening Agents"},
            {ingredient: "yeast", purchasePrice: 1600, packageWeight: 500, category: "Leavening Agents"},
            {ingredient: "vanilla essence", purchasePrice: 1200, packageWeight: 900, category: "Flavorings"},
            {ingredient: "vanilla powder", purchasePrice: 600, packageWeight: 500, category: "Flavorings"},
            {ingredient: "cocoa powder", purchasePrice: 26500, packageWeight: 25000, category: "Flavorings"},
            {ingredient: "cinnamon", purchasePrice: null, packageWeight: null, category: "Spices"},
            {ingredient: "nutmeg", purchasePrice: null, packageWeight: null, category: "Spices"},
            {ingredient: "salt", purchasePrice: 50, packageWeight: 1000, category: "Seasonings"},
            {ingredient: "youngs milky", purchasePrice: 12350, packageWeight: 10000, category: "Flavorings"},
            {ingredient: "youngs hazelnut", purchasePrice: 9020, packageWeight: 6000, category: "Flavorings"},
            {ingredient: "youngs cocoa powder", purchasePrice: null, packageWeight: null, category: "Flavorings"},
            {ingredient: "youngs dark compound", purchasePrice: null, packageWeight: null, category: "Chocolate"},
            {ingredient: "mocca dark compound", purchasePrice: 850, packageWeight: 1000, category: "Chocolate"},
            {ingredient: "premium dark compound", purchasePrice: 850, packageWeight: 1000, category: "Chocolate"},
            {ingredient: "walnuts", purchasePrice: 2000, packageWeight: 1000, category: "Nuts"},
            {ingredient: "almonds", purchasePrice: 3000, packageWeight: 1000, category: "Nuts"},
            {ingredient: "pistachio nuts", purchasePrice: 4000, packageWeight: 1000, category: "Nuts"},
            {ingredient: "vinegar", purchasePrice: 900, packageWeight: 5000, category: "Acids"},
            {ingredient: "orange oil", purchasePrice: 880, packageWeight: 400, category: "Flavorings"},
            {ingredient: "coconut oil", purchasePrice: null, packageWeight: null, category: "Fats & Oils"},
            {ingredient: "lafruta raspberry filling", purchasePrice: 18000, packageWeight: 60000, category: "Fillings"},
            {ingredient: "lotus filling", purchasePrice: 9300, packageWeight: 30000, category: "Fillings"},
            {ingredient: "millionare caramel filling", purchasePrice: 25600, packageWeight: 12500, category: "Fillings"},
            {ingredient: "pistachio creamy 26%", purchasePrice: 14250, packageWeight: 3000, category: "Fillings"},
            {ingredient: "kunafa roasted", purchasePrice: 2000, packageWeight: 1000, category: "Dry Goods"}
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Populate categories dropdown
            updateCategories();
            
            // Populate ingredients dropdown
            populateIngredients();

            // Event listeners
            document.getElementById('category-filter').addEventListener('change', populateIngredients);
            document.getElementById('add-ingredient-btn').addEventListener('click', addSelectedIngredient);
            document.getElementById('toggle-new-ingredient-form').addEventListener('click', toggleNewIngredientForm);
            document.getElementById('save-new-ingredient').addEventListener('click', saveNewIngredient);
            document.getElementById('calculate-btn').addEventListener('click', calculateCosts);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('import-csv-btn').addEventListener('click', importCSV);
            document.getElementById('csv-file').addEventListener('change', previewCSV);

            // Initialize charts
            initializeCharts();
        });

        // Update categories dropdown
        function updateCategories() {
            const categories = [...new Set(ingredientData.map(item => item.category))].filter(cat => cat);
            const categoryFilter = document.getElementById('category-filter');
            
            // Clear existing options except the first one
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Populate ingredients based on selected category
        function populateIngredients() {
            const categoryFilter = document.getElementById('category-filter').value;
            const ingredientSelect = document.getElementById('ingredient-select');
            
            // Clear existing options except the first one
            while (ingredientSelect.options.length > 1) {
                ingredientSelect.remove(1);
            }
            
            // Filter ingredients by category
            const filteredIngredients = categoryFilter === 'all' 
                ? ingredientData 
                : ingredientData.filter(item => item.category === categoryFilter);
            
            // Add filtered ingredients to dropdown
            filteredIngredients.forEach(ingredient => {
                if (ingredient.ingredient) {
                    const option = document.createElement('option');
                    option.value = ingredient.ingredient;
                    option.textContent = ingredient.ingredient;
                    option.dataset.price = ingredient.purchasePrice || '';
                    option.dataset.weight = ingredient.packageWeight || '';
                    ingredientSelect.appendChild(option);
                }
            });
        }

        // Add selected ingredient to the table
        function addSelectedIngredient() {
            const ingredientSelect = document.getElementById('ingredient-select');
            const selectedOption = ingredientSelect.options[ingredientSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Please select an ingredient first');
                return;
            }
            
            const ingredientName = selectedOption.value;
            const purchasePrice = selectedOption.dataset.price || 0;
            const packageWeight = selectedOption.dataset.weight || 0;
            
            // Check if ingredient already exists in the table
            const existingRows = document.querySelectorAll('#selected-ingredients tbody tr');
            for (let row of existingRows) {
                if (row.cells[0].textContent === ingredientName) {
                    alert('This ingredient is already in your recipe');
                    return;
                }
            }
            
            // Calculate per gram price
            const perGramPrice = packageWeight > 0 ? (purchasePrice / packageWeight).toFixed(4) : 0;
            
            // Add row to table
            const tbody = document.querySelector('#selected-ingredients tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${ingredientName}</td>
                <td><input type="number" value="${purchasePrice}" class="price-input"></td>
                <td><input type="number" value="${packageWeight}" class="weight-input"></td>
                <td class="per-gram-price">${perGramPrice}</td>
                <td><input type="number" class="required-weight" placeholder="Enter weight in grams"></td>
                <td class="ingredient-cost">PKR 0.00</td>
                <td><button class="delete-btn">×</button></td>
            `;
            
            tbody.appendChild(newRow);
            
            // Add event listeners to the new row
            const priceInput = newRow.querySelector('.price-input');
            const weightInput = newRow.querySelector('.weight-input');
            const requiredWeightInput = newRow.querySelector('.required-weight');
            const deleteBtn = newRow.querySelector('.delete-btn');
            
            priceInput.addEventListener('input', updatePerGramPrice);
            weightInput.addEventListener('input', updatePerGramPrice);
            requiredWeightInput.addEventListener('input', updateIngredientCost);
            deleteBtn.addEventListener('click', function() {
                newRow.remove();
                calculateCosts();
            });
            
            // Reset the select
            ingredientSelect.selectedIndex = 0;
        }

        // Update per gram price when price or package weight changes
        function updatePerGramPrice(event) {
            const row = event.target.closest('tr');
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const weight = parseFloat(row.querySelector('.weight-input').value) || 0;
            const perGramCell = row.querySelector('.per-gram-price');
            
            if (weight > 0) {
                const perGramPrice = (price / weight).toFixed(4);
                perGramCell.textContent = perGramPrice;
            } else {
                perGramCell.textContent = '0';
            }
            
            // Also update the ingredient cost if required weight is set
            const requiredWeightInput = row.querySelector('.required-weight');
            if (requiredWeightInput.value) {
                updateIngredientCost.call(requiredWeightInput);
            }
        }

        // Update ingredient cost when required weight changes
        function updateIngredientCost() {
            const row = this.closest('tr');
            const perGramPrice = parseFloat(row.querySelector('.per-gram-price').textContent) || 0;
            const requiredWeight = parseFloat(this.value) || 0;
            const costCell = row.querySelector('.ingredient-cost');
            
            const cost = perGramPrice * requiredWeight;
            costCell.textContent = `PKR ${cost.toFixed(2)}`;
        }

        // Toggle new ingredient form
        function toggleNewIngredientForm() {
            const form = document.getElementById('new-ingredient-form');
            form.classList.toggle('hidden');
        }

        // Save new ingredient
        function saveNewIngredient() {
            const name = document.getElementById('new-ingredient-name').value;
            const price = parseFloat(document.getElementById('new-ingredient-price').value) || 0;
            const weight = parseFloat(document.getElementById('new-ingredient-weight').value) || 0;
            const category = document.getElementById('new-ingredient-category').value;
            
            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }
            
            // Add to ingredient data
            ingredientData.push({
                ingredient: name,
                purchasePrice: price,
                packageWeight: weight,
                category: category || 'Other'
            });
            
            // Update categories and repopulate ingredients dropdown
            updateCategories();
            populateIngredients();
            
            // Reset form and hide it
            document.getElementById('new-ingredient-name').value = '';
            document.getElementById('new-ingredient-price').value = '';
            document.getElementById('new-ingredient-weight').value = '';
            document.getElementById('new-ingredient-category').value = '';
            document.getElementById('new-ingredient-form').classList.add('hidden');
            
            alert('New ingredient added successfully!');
        }

        // Calculate all costs
        function calculateCosts() {
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            let totalCost = 0;
            let totalWeight = 0;
            
            // Calculate total cost and weight
            rows.forEach(row => {
                const cost = parseFloat(row.querySelector('.ingredient-cost').textContent.replace('PKR ', '')) || 0;
                const weight = parseFloat(row.querySelector('.required-weight').value) || 0;
                
                totalCost += cost;
                totalWeight += weight;
            });
            
            // Update summary cards
            document.getElementById('total-cost').textContent = `PKR ${totalCost.toFixed(2)}`;
            
            const perGramCost = totalWeight > 0 ? totalCost / totalWeight : 0;
            document.getElementById('per-gram-cost').textContent = `PKR ${perGramCost.toFixed(4)}`;
            
            const servingGrams = parseFloat(document.getElementById('serving-grams').value) || 0;
            const perServingCost = servingGrams > 0 ? perGramCost * servingGrams : 0;
            document.getElementById('per-serving-cost').textContent = `PKR ${perServingCost.toFixed(2)}`;
            
            // Calculate selling price and profit
            const marginPercentage = parseFloat(document.getElementById('margin-percentage').value) || 0;
            const sellingPrice = perServingCost * (1 + marginPercentage / 100);
            const profitPerServing = sellingPrice - perServingCost;
            
            document.getElementById('selling-price').textContent = `PKR ${sellingPrice.toFixed(2)}`;
            document.getElementById('profit-per-serving').textContent = `PKR ${profitPerServing.toFixed(2)}`;
            
            // Update charts
            updateCharts();
        }

        // Initialize charts
        function initializeCharts() {
            const costCtx = document.getElementById('cost-breakdown-chart').getContext('2d');
            const weightCtx = document.getElementById('weight-breakdown-chart').getContext('2d');
            
            window.costChart = new Chart(costCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost Breakdown by Ingredient (PKR)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            window.weightChart = new Chart(weightCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight Breakdown by Ingredient (g)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            const costLabels = [];
            const costData = [];
            const weightLabels = [];
            const weightData = [];
            
            rows.forEach(row => {
                const name = row.cells[0].textContent;
                const cost = parseFloat(row.querySelector('.ingredient-cost').textContent.replace('PKR ', '')) || 0;
                const weight = parseFloat(row.querySelector('.required-weight').value) || 0;
                
                if (cost > 0) {
                    costLabels.push(name);
                    costData.push(cost);
                }
                
                if (weight > 0) {
                    weightLabels.push(name);
                    weightData.push(weight);
                }
            });
            
            window.costChart.data.labels = costLabels;
            window.costChart.data.datasets[0].data = costData;
            window.costChart.update();
            
            window.weightChart.data.labels = weightLabels;
            window.weightChart.data.datasets[0].data = weightData;
            window.weightChart.update();
        }

        // Preview CSV file before import
        function previewCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    const previewDiv = document.getElementById('csv-preview');
                    const previewTable = document.getElementById('preview-table');
                    
                    // Clear previous preview
                    previewTable.innerHTML = '';
                    
                    if (results.data.length === 0) {
                        previewDiv.classList.add('hidden');
                        return;
                    }
                    
                    // Create table header
                    const headerRow = document.createElement('tr');
                    Object.keys(results.data[0]).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                    previewTable.appendChild(headerRow);
                    
                    // Create table rows with data
                    results.data.slice(0, 5).forEach(row => { // Show first 5 rows only
                        const tr = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            tr.appendChild(td);
                        });
                        previewTable.appendChild(tr);
                    });
                    
                    previewDiv.classList.remove('hidden');
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    alert('Error parsing CSV file. Please check the format.');
                }
            });
        }

        // Import CSV data
        function importCSV() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }
            
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        alert('No data found in CSV file');
                        return;
                    }
                    
                    // Clear existing ingredient data
                    ingredientData = [];
                    
                    // Process each row
                    results.data.forEach(row => {
                        if (row.ingredient && row.ingredient.trim() !== '') {
                            ingredientData.push({
                                ingredient: row.ingredient.trim(),
                                purchasePrice: parseFloat(row['purchase price']) || null,
                                packageWeight: parseFloat(row['package weight']) || null,
                                category: row.category || 'Other'
                            });
                        }
                    });
                    
                    // Update the UI with new data
                    updateCategories();
                    populateIngredients();
                    
                    // Reset file input and hide preview
                    fileInput.value = '';
                    document.getElementById('csv-preview').classList.add('hidden');
                    
                    alert(`Successfully imported ${ingredientData.length} ingredients from CSV!`);
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    alert('Error parsing CSV file. Please check the format.');
                }
            });
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Recipe name
            const recipeName = document.getElementById('recipe-name').value || 'Unnamed Recipe';
            doc.setFontSize(20);
            doc.text(recipeName, 20, 20);
            
            // Serving size
            const servingGrams = document.getElementById('serving-grams').value || 'N/A';
            doc.setFontSize(12);
            doc.text(`Serving Size: ${servingGrams} grams`, 20, 35);
            
            // Ingredients table
            doc.text('Ingredients:', 20, 50);
            let yPosition = 60;
            
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            rows.forEach((row, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const name = row.cells[0].textContent;
                const price = row.querySelector('.price-input').value;
                const pkgWeight = row.querySelector('.weight-input').value;
                const perGram = row.querySelector('.per-gram-price').textContent;
                const reqWeight = row.querySelector('.required-weight').value;
                const cost = row.querySelector('.ingredient-cost').textContent;
                
                doc.text(`${index + 1}. ${name}`, 20, yPosition);
                doc.text(`Purchase Price: PKR ${price} | Package: ${pkgWeight}g | Per Gram: PKR ${perGram}`, 30, yPosition + 5);
                doc.text(`Required: ${reqWeight}g | Cost: ${cost}`, 30, yPosition + 10);
                
                yPosition += 20;
            });
            
            // Cost summary
            yPosition += 10;
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.text('Cost Summary:', 20, yPosition);
            yPosition += 10;
            
            const totalCost = document.getElementById('total-cost').textContent;
            const perGramCost = document.getElementById('per-gram-cost').textContent;
            const perServingCost = document.getElementById('per-serving-cost').textContent;
            const sellingPrice = document.getElementById('selling-price').textContent;
            const profit = document.getElementById('profit-per-serving').textContent;
            
            doc.text(`Total Recipe Cost: ${totalCost}`, 30, yPosition);
            doc.text(`Cost Per Gram: ${perGramCost}`, 30, yPosition + 5);
            doc.text(`Cost Per Serving: ${perServingCost}`, 30, yPosition + 10);
            doc.text(`Selling Price: ${sellingPrice}`, 30, yPosition + 15);
            doc.text(`Profit Per Serving: ${profit}`, 30, yPosition + 20);
            
            // Save the PDF
            doc.save(`${recipeName.replace(/\s+/g, '_')}_cost_analysis.pdf`);
        }

        // Export ingredients to CSV
        function exportToCSV() {
            // Create CSV content
            let csvContent = "ingredient,purchase price,package weight,category\n";
            
            ingredientData.forEach(item => {
                csvContent += `"${item.ingredient}",${item.purchasePrice || ''},${item.packageWeight || ''},"${item.category || ''}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'ingredients_inventory.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
