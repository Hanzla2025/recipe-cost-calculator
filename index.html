<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Cost Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff7e5f;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
            font-size: 1.8rem;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--secondary);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .ingredient-row > * {
            flex: 1;
        }
        
        .ingredient-row .delete-btn {
            flex: 0 0 40px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-wrapper {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .summary-card p {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .new-ingredient-form {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .new-ingredient-form h3 {
            margin-bottom: 15px;
        }
        
        .new-ingredient-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .new-ingredient-row > * {
            flex: 1;
        }
        
        .csv-import-section {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .csv-import-section h3 {
            margin-bottom: 15px;
        }
        
        .csv-preview {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }
        
        .currency-symbol {
            font-weight: bold;
            color: var(--primary);
        }
        
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-item.selected {
            background-color: var(--light);
            border-left: 3px solid var(--primary);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .weight-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .weight-card {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }
        
        .weight-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .weight-card p {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .weight-card.total-weight {
            background-color: #e8f4fd;
            border-left: 4px solid var(--accent);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .section {
                padding: 12px;
            }
            
            .ingredient-row, .new-ingredient-row {
                flex-direction: column;
            }
            
            .charts-container {
                flex-direction: column;
            }
            
            .chart-wrapper {
                min-width: 100%;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .summary, .weight-summary {
                grid-template-columns: 1fr;
            }
            
            .search-results {
                max-height: 150px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .section {
                padding: 10px;
                margin-bottom: 20px;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 6px 8px;
            }
            
            .summary-card, .weight-card {
                padding: 10px;
            }
            
            .summary-card p, .weight-card p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recipe Cost Calculator <span class="currency-symbol">(PKR)</span></h1>
        
        <!-- Section 1: Recipe Name and Serving Size -->
        <div class="section">
            <h2>Recipe Information</h2>
            <div class="form-group">
                <label for="recipe-name">Recipe Name</label>
                <input type="text" id="recipe-name" placeholder="Enter recipe name">
            </div>
            <div class="form-group">
                <label for="serving-grams">Serving Size (grams)</label>
                <input type="number" id="serving-grams" placeholder="Enter serving size in grams" value="100">
            </div>
        </div>
        
        <!-- Section 2: Ingredient Selection -->
        <div class="section">
            <h2>Ingredients</h2>
            
            <div class="form-group">
                <button id="load-data-btn" class="btn-success">
                    <span id="load-text">Load Latest Prices from Google Sheets</span>
                    <span id="load-spinner" class="loading hidden"></span>
                </button>
                <div id="load-status" style="margin-top: 10px; font-size: 14px;"></div>
            </div>
            
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter">
                    <option value="all">All Categories</option>
                </select>
            </div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <label for="ingredient-search">Search Ingredients</label>
                <input type="text" id="ingredient-search" placeholder="Type to search ingredients... Press ↓↑ to navigate, Enter to select">
                <div id="search-results" class="search-results hidden"></div>
            </div>
            
            <div class="form-group">
                <label for="ingredient-select">Select Ingredient</label>
                <select id="ingredient-select">
                    <option value="">-- Select an ingredient --</option>
                </select>
            </div>
            
            <div class="form-group">
                <button id="add-ingredient-btn" class="btn-secondary">Add Selected Ingredient</button>
            </div>

            <!-- Selected Ingredients Table -->
            <div style="overflow-x: auto;">
                <table id="selected-ingredients">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Purchase Price (PKR)</th>
                            <th>Package Weight (g)</th>
                            <th>Per Gram Price (PKR)</th>
                            <th>Required Weight (g)</th>
                            <th>Cost (PKR)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Section 3: Total Weight Summary -->
        <div class="section">
            <h2>Recipe Weight Summary</h2>
            <div class="weight-summary">
                <div class="weight-card total-weight">
                    <h3>Total Recipe Weight</h3>
                    <p id="total-recipe-weight">0 g</p>
                </div>
                <div class="weight-card">
                    <h3>Number of Servings</h3>
                    <p id="number-of-servings">0</p>
                </div>
                <div class="weight-card">
                    <h3>Weight Per Serving</h3>
                    <p id="weight-per-serving">0 g</p>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Cost Calculation and Analysis -->
        <div class="section">
            <h2>Cost Analysis</h2>
            
            <div class="summary">
                <div class="summary-card">
                    <h3>Total Recipe Cost</h3>
                    <p id="total-cost">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Cost Per Gram</h3>
                    <p id="per-gram-cost">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Cost Per Serving</h3>
                    <p id="per-serving-cost">PKR 0.00</p>
                </div>
            </div>
            
            <div class="form-group">
                <label for="margin-percentage">Desired Margin Percentage</label>
                <input type="number" id="margin-percentage" placeholder="Enter margin percentage" value="30">
            </div>
            
            <div class="summary">
                <div class="summary-card">
                    <h3>Selling Price</h3>
                    <p id="selling-price">PKR 0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Profit Per Serving</h3>
                    <p id="profit-per-serving">PKR 0.00</p>
                </div>
            </div>
        </div>
        
        <!-- Section 5: Visualization -->
        <div class="section">
            <h2>Recipe Breakdown</h2>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="cost-breakdown-chart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="weight-breakdown-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Section 6: Export -->
        <div class="section">
            <h2>Export Recipe</h2>
            <button id="export-pdf-btn" class="btn-secondary">Download PDF Report</button>
        </div>
    </div>

    <script>
        // Ingredient data - will be populated from Google Sheets
        let ingredientData = [];
        
        // Google Sheets URL
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQOjljUlumLK8Xl2y20G0hMe-KoCFNsxDnof4hkSZitNAjbcFOWxK4ngFqDwloI_6uMAWRCZLLyorjx/pub?gid=0&single=true&output=csv';

        // Variables for keyboard navigation
        let searchResults = [];
        let selectedResultIndex = -1;
        let isSearchActive = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from Google Sheets on startup
            loadDataFromGoogleSheets();
            
            // Event listeners
            document.getElementById('load-data-btn').addEventListener('click', loadDataFromGoogleSheets);
            document.getElementById('category-filter').addEventListener('change', populateIngredients);
            document.getElementById('add-ingredient-btn').addEventListener('click', addSelectedIngredient);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('margin-percentage').addEventListener('input', calculateCosts);
            document.getElementById('serving-grams').addEventListener('input', calculateCosts);
            
            // Search functionality with keyboard navigation
            const searchInput = document.getElementById('ingredient-search');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keydown', handleKeyboardNavigation);
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    if (!isSearchActive) {
                        document.getElementById('search-results').classList.add('hidden');
                    }
                }, 200);
            });
            searchInput.addEventListener('focus', function() {
                isSearchActive = true;
                if (searchInput.value.length >= 2) {
                    handleSearch({target: searchInput});
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    isSearchActive = false;
                    document.getElementById('search-results').classList.add('hidden');
                }
            });

            // Initialize charts
            initializeCharts();
        });

        // Handle keyboard navigation in search
        function handleKeyboardNavigation(e) {
            const searchResultsDiv = document.getElementById('search-results');
            const isVisible = !searchResultsDiv.classList.contains('hidden');
            
            if (!isVisible || searchResults.length === 0) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    navigateSearchResults(1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    navigateSearchResults(-1);
                    break;
                case 'Enter':
                    e.preventDefault();
                    selectSearchResult();
                    break;
                case 'Escape':
                    searchResultsDiv.classList.add('hidden');
                    selectedResultIndex = -1;
                    break;
            }
        }

        // Navigate through search results
        function navigateSearchResults(direction) {
            if (searchResults.length === 0) return;

            // Remove previous selection
            if (selectedResultIndex >= 0) {
                document.querySelectorAll('.search-result-item')[selectedResultIndex].classList.remove('selected');
            }

            // Calculate new index
            selectedResultIndex += direction;
            
            // Handle bounds
            if (selectedResultIndex < 0) {
                selectedResultIndex = searchResults.length - 1;
            } else if (selectedResultIndex >= searchResults.length) {
                selectedResultIndex = 0;
            }

            // Add new selection
            const items = document.querySelectorAll('.search-result-item');
            items[selectedResultIndex].classList.add('selected');
            
            // Scroll into view if needed
            items[selectedResultIndex].scrollIntoView({ block: 'nearest' });
        }

        // Select the currently highlighted search result
        function selectSearchResult() {
            if (selectedResultIndex >= 0 && selectedResultIndex < searchResults.length) {
                const ingredient = searchResults[selectedResultIndex];
                addIngredientFromSearch(ingredient);
                
                // Clear search
                document.getElementById('ingredient-search').value = '';
                document.getElementById('search-results').classList.add('hidden');
                selectedResultIndex = -1;
                searchResults = [];
            }
        }

        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            const loadBtn = document.getElementById('load-data-btn');
            const loadText = document.getElementById('load-text');
            const loadSpinner = document.getElementById('load-spinner');
            const statusDiv = document.getElementById('load-status');
            
            // Show loading state
            loadText.textContent = 'Loading...';
            loadSpinner.classList.remove('hidden');
            loadBtn.disabled = true;
            statusDiv.textContent = 'Fetching data from Google Sheets...';
            statusDiv.style.color = 'var(--warning)';
            
            try {
                // Add timestamp to avoid caching issues
                const url = GOOGLE_SHEETS_URL + '&t=' + new Date().getTime();
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvData = await response.text();
                
                if (!csvData || csvData.trim().length === 0) {
                    throw new Error('No data received from Google Sheets');
                }
                
                // Parse CSV data
                const rows = parseCSV(csvData);
                
                if (rows.length === 0) {
                    throw new Error('No valid data found in CSV');
                }
                
                // Clear existing data
                ingredientData = [];
                
                // Process each row
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    
                    // Skip empty rows or rows without enough data
                    if (!row || row.length < 3) continue;
                    
                    const ingredient = (row[0] || '').trim();
                    const purchasePrice = parseFloat((row[1] || '').replace(/[^\d.-]/g, '')) || null;
                    const packageWeight = parseFloat((row[2] || '').replace(/[^\d.-]/g, '')) || null;
                    
                    // Skip if no ingredient name
                    if (!ingredient) continue;
                    
                    // Determine category based on ingredient name
                    const category = determineCategory(ingredient);
                    
                    ingredientData.push({
                        ingredient: ingredient,
                        purchasePrice: purchasePrice,
                        packageWeight: packageWeight,
                        category: category
                    });
                }
                
                // Update the UI with new data
                updateCategories();
                populateIngredients();
                
                // Show success message
                statusDiv.textContent = `✅ Successfully loaded ${ingredientData.length} ingredients!`;
                statusDiv.style.color = 'var(--success)';
                loadText.textContent = 'Refresh Prices from Google Sheets';
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                statusDiv.textContent = `❌ Error: ${error.message}. Using fallback data.`;
                statusDiv.style.color = 'var(--danger)';
                loadText.textContent = 'Retry Loading Data';
                
                // Load fallback data
                loadFallbackData();
            } finally {
                // Hide loading state
                loadSpinner.classList.add('hidden');
                loadBtn.disabled = false;
            }
        }

        // Robust CSV parsing function
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentValue.trim());
                    currentValue = '';
                } else if (char === '\n' && !inQuotes) {
                    currentRow.push(currentValue.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentValue = '';
                } else if (char === '\r' && nextChar === '\n' && !inQuotes) {
                    // Handle Windows line endings
                    currentRow.push(currentValue.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentValue = '';
                    i++; // Skip the next character (\n)
                } else {
                    currentValue += char;
                }
            }
            
            // Add the last row
            if (currentValue.trim() || currentRow.length > 0) {
                currentRow.push(currentValue.trim());
                rows.push(currentRow);
            }
            
            return rows;
        }

        // Fallback data in case Google Sheets fails
        function loadFallbackData() {
            ingredientData = [
                {ingredient: "flour", purchasePrice: 6400, packageWeight: 50000, category: "Dry Goods"},
                {ingredient: "semolina", purchasePrice: 180, packageWeight: 1000, category: "Dry Goods"},
                {ingredient: "granulated sugar", purchasePrice: 10200, packageWeight: 50000, category: "Sweeteners"},
                {ingredient: "packet brown sugar", purchasePrice: 450, packageWeight: 800, category: "Sweeteners"},
                {ingredient: "open brown sugar", purchasePrice: 250, packageWeight: 1000, category: "Sweeteners"},
                {ingredient: "open icing sugar", purchasePrice: 200, packageWeight: 1000, category: "Sweeteners"},
                {ingredient: "packet icing sugar", purchasePrice: 490, packageWeight: 800, category: "Sweeteners"},
                {ingredient: "honey", purchasePrice: 2500, packageWeight: 1000, category: "Sweeteners"},
                {ingredient: "glucose", purchasePrice: 450, packageWeight: 1000, category: "Sweeteners"},
                {ingredient: "blanco butter", purchasePrice: 950, packageWeight: 1000, category: "Dairy"},
                {ingredient: "faisalabad butter", purchasePrice: 1680, packageWeight: 1000, category: "Dairy"},
                {ingredient: "fauji oil", purchasePrice: 7650, packageWeight: 16000, category: "Fats & Oils"},
                {ingredient: "meezan oil", purchasePrice: 7800, packageWeight: 16000, category: "Fats & Oils"},
                {ingredient: "sofi ghee", purchasePrice: 9300, packageWeight: 16000, category: "Fats & Oils"},
                {ingredient: "khoya", purchasePrice: 1450, packageWeight: 1000, category: "Dairy"},
                {ingredient: "olpers milk", purchasePrice: 4000, packageWeight: 12000, category: "Dairy"},
                {ingredient: "milkfield milk", purchasePrice: 3360, packageWeight: 12000, category: "Dairy"},
                {ingredient: "asli milk", purchasePrice: 3300, packageWeight: 12000, category: "Dairy"},
                {ingredient: "condensed milk", purchasePrice: 12720, packageWeight: 24000, category: "Dairy"},
                {ingredient: "evaporated", purchasePrice: 16800, packageWeight: 18720, category: "Dairy"},
                {ingredient: "master-chef whipping cream", purchasePrice: 350, packageWeight: 350, category: "Dairy"},
                {ingredient: "youngs whipping cream", purchasePrice: 540, packageWeight: 550, category: "Dairy"},
                {ingredient: "whipy whip whipping cream", purchasePrice: 7600, packageWeight: 12000, category: "Dairy"},
                {ingredient: "silver whipping cream", purchasePrice: 18000, packageWeight: 12000, category: "Dairy"},
                {ingredient: "blanco whipping cream", purchasePrice: 6600, packageWeight: 12000, category: "Dairy"},
                {ingredient: "milkfield heavy-cream", purchasePrice: 4600, packageWeight: 4800, category: "Dairy"},
                {ingredient: "creamym heavy-cream", purchasePrice: 3800, packageWeight: 4800, category: "Dairy"},
                {ingredient: "omang dobala heavy-cream", purchasePrice: 3700, packageWeight: 4800, category: "Dairy"},
                {ingredient: "yougurt", purchasePrice: 260, packageWeight: 1000, category: "Dairy"},
                {ingredient: "whole eggs", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
                {ingredient: "eggs yolk", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
                {ingredient: "eggs white", purchasePrice: 10200, packageWeight: 360, category: "Eggs"},
                {ingredient: "baking powder", purchasePrice: 1800, packageWeight: 4400, category: "Leavening Agents"},
                {ingredient: "baking soda", purchasePrice: 200, packageWeight: 1000, category: "Leavening Agents"},
                {ingredient: "yeast", purchasePrice: 1600, packageWeight: 500, category: "Leavening Agents"},
                {ingredient: "vanilla essence", purchasePrice: 1200, packageWeight: 900, category: "Flavorings"},
                {ingredient: "vanilla powder", purchasePrice: 600, packageWeight: 500, category: "Flavorings"},
                {ingredient: "cocoa powder", purchasePrice: 26500, packageWeight: 25000, category: "Flavorings"},
                {ingredient: "cinnamon", purchasePrice: null, packageWeight: null, category: "Spices"},
                {ingredient: "nutmeg", purchasePrice: null, packageWeight: null, category: "Spices"},
                {ingredient: "salt", purchasePrice: 50, packageWeight: 1000, category: "Seasonings"},
                {ingredient: "youngs milky", purchasePrice: 12350, packageWeight: 10000, category: "Flavorings"},
                {ingredient: "youngs hazelnut", purchasePrice: 9020, packageWeight: 6000, category: "Flavorings"},
                {ingredient: "youngs cocoa powder", purchasePrice: null, packageWeight: null, category: "Flavorings"},
                {ingredient: "youngs dark compound", purchasePrice: null, packageWeight: null, category: "Chocolate"},
                {ingredient: "mocca dark compound", purchasePrice: 850, packageWeight: 1000, category: "Chocolate"},
                {ingredient: "premium dark compound", purchasePrice: 850, packageWeight: 1000, category: "Chocolate"},
                {ingredient: "walnuts", purchasePrice: 2000, packageWeight: 1000, category: "Nuts"},
                {ingredient: "almonds", purchasePrice: 3000, packageWeight: 1000, category: "Nuts"},
                {ingredient: "pistachio nuts", purchasePrice: 4000, packageWeight: 1000, category: "Nuts"},
                {ingredient: "vinegar", purchasePrice: 900, packageWeight: 5000, category: "Acids"},
                {ingredient: "orange oil", purchasePrice: 880, packageWeight: 400, category: "Flavorings"},
                {ingredient: "coconut oil", purchasePrice: null, packageWeight: null, category: "Fats & Oils"},
                {ingredient: "lafruta raspberry filling", purchasePrice: 18000, packageWeight: 60000, category: "Fillings"},
                {ingredient: "lotus filling", purchasePrice: 9300, packageWeight: 30000, category: "Fillings"},
                {ingredient: "millionare caramel filling", purchasePrice: 25600, packageWeight: 12500, category: "Fillings"},
                {ingredient: "pistachio creamy 26%", purchasePrice: 14250, packageWeight: 3000, category: "Fillings"},
                {ingredient: "kunafa roasted", purchasePrice: 2000, packageWeight: 1000, category: "Dry Goods"}
            ];
            
            updateCategories();
            populateIngredients();
        }

        // Determine category based on ingredient name
        function determineCategory(ingredientName) {
            const name = ingredientName.toLowerCase();
            
            if (name.includes('flour') || name.includes('semolina') || name.includes('kunafa')) {
                return 'Dry Goods';
            } else if (name.includes('sugar') || name.includes('honey') || name.includes('glucose')) {
                return 'Sweeteners';
            } else if (name.includes('butter') || name.includes('milk') || name.includes('cream') || name.includes('yogurt') || name.includes('khoya')) {
                return 'Dairy';
            } else if (name.includes('oil') || name.includes('ghee')) {
                return 'Fats & Oils';
            } else if (name.includes('egg')) {
                return 'Eggs';
            } else if (name.includes('baking') || name.includes('yeast')) {
                return 'Leavening Agents';
            } else if (name.includes('vanilla') || name.includes('cocoa') || name.includes('cinnamon') || name.includes('nutmeg') || name.includes('orange')) {
                return 'Flavorings';
            } else if (name.includes('salt')) {
                return 'Seasonings';
            } else if (name.includes('walnut') || name.includes('almond') || name.includes('pistachio')) {
                return 'Nuts';
            } else if (name.includes('vinegar')) {
                return 'Acids';
            } else if (name.includes('filling')) {
                return 'Fillings';
            } else if (name.includes('compound')) {
                return 'Chocolate';
            } else if (name.includes('spice')) {
                return 'Spices';
            }
            
            return 'Other';
        }

        // Search functionality
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const searchResultsDiv = document.getElementById('search-results');
            
            if (searchTerm.length < 2) {
                searchResultsDiv.classList.add('hidden');
                selectedResultIndex = -1;
                searchResults = [];
                return;
            }
            
            // Filter ingredients based on search term
            const filteredIngredients = ingredientData.filter(item => 
                item.ingredient.toLowerCase().includes(searchTerm)
            );
            
            // Store filtered results globally
            searchResults = filteredIngredients;
            selectedResultIndex = -1;
            
            // Display search results
            if (filteredIngredients.length > 0) {
                searchResultsDiv.innerHTML = '';
                
                filteredIngredients.forEach((ingredient, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.textContent = ingredient.ingredient;
                    resultItem.dataset.index = index;
                    
                    resultItem.addEventListener('click', () => {
                        addIngredientFromSearch(ingredient);
                        document.getElementById('ingredient-search').value = '';
                        searchResultsDiv.classList.add('hidden');
                        selectedResultIndex = -1;
                        searchResults = [];
                    });
                    
                    resultItem.addEventListener('mouseenter', () => {
                        // Clear previous selection
                        document.querySelectorAll('.search-result-item.selected').forEach(item => {
                            item.classList.remove('selected');
                        });
                        // Set new selection
                        resultItem.classList.add('selected');
                        selectedResultIndex = index;
                    });
                    
                    searchResultsDiv.appendChild(resultItem);
                });
                
                searchResultsDiv.classList.remove('hidden');
                isSearchActive = true;
                
            } else {
                searchResultsDiv.innerHTML = '<div class="search-result-item">No ingredients found</div>';
                searchResultsDiv.classList.remove('hidden');
                isSearchActive = true;
            }
        }

        // Add ingredient from search results
        function addIngredientFromSearch(ingredient) {
            const existingRows = document.querySelectorAll('#selected-ingredients tbody tr');
            for (let row of existingRows) {
                if (row.cells[0].textContent === ingredient.ingredient) {
                    alert('This ingredient is already in your recipe');
                    return;
                }
            }
            
            const perGramPrice = ingredient.packageWeight > 0 && ingredient.purchasePrice > 0 ? 
                (ingredient.purchasePrice / ingredient.packageWeight).toFixed(4) : 0;
            
            const tbody = document.querySelector('#selected-ingredients tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${ingredient.ingredient}</td>
                <td><input type="number" value="${ingredient.purchasePrice || 0}" class="price-input"></td>
                <td><input type="number" value="${ingredient.packageWeight || 0}" class="weight-input"></td>
                <td class="per-gram-price">${perGramPrice}</td>
                <td><input type="number" class="required-weight" placeholder="Enter weight in grams" value="100"></td>
                <td class="ingredient-cost">PKR ${(perGramPrice * 100).toFixed(2)}</td>
                <td><button class="delete-btn">×</button></td>
            `;
            
            tbody.appendChild(newRow);
            
            const priceInput = newRow.querySelector('.price-input');
            const weightInput = newRow.querySelector('.weight-input');
            const requiredWeightInput = newRow.querySelector('.required-weight');
            const deleteBtn = newRow.querySelector('.delete-btn');
            
            priceInput.addEventListener('input', function() {
                updatePerGramPrice.call(this);
                calculateCosts();
            });
            weightInput.addEventListener('input', function() {
                updatePerGramPrice.call(this);
                calculateCosts();
            });
            requiredWeightInput.addEventListener('input', function() {
                updateIngredientCost.call(this);
                calculateCosts();
            });
            deleteBtn.addEventListener('click', function() {
                newRow.remove();
                calculateCosts();
            });
            
            calculateCosts();
        }

        // Update categories dropdown
        function updateCategories() {
            const categories = [...new Set(ingredientData.map(item => item.category))].filter(cat => cat);
            const categoryFilter = document.getElementById('category-filter');
            
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Populate ingredients based on selected category
        function populateIngredients() {
            const categoryFilter = document.getElementById('category-filter').value;
            const ingredientSelect = document.getElementById('ingredient-select');
            
            while (ingredientSelect.options.length > 1) {
                ingredientSelect.remove(1);
            }
            
            const filteredIngredients = categoryFilter === 'all' 
                ? ingredientData 
                : ingredientData.filter(item => item.category === categoryFilter);
            
            filteredIngredients.forEach(ingredient => {
                if (ingredient.ingredient) {
                    const option = document.createElement('option');
                    option.value = ingredient.ingredient;
                    option.textContent = ingredient.ingredient;
                    option.dataset.price = ingredient.purchasePrice || '';
                    option.dataset.weight = ingredient.packageWeight || '';
                    ingredientSelect.appendChild(option);
                }
            });
        }

        // Add selected ingredient to the table
        function addSelectedIngredient() {
            const ingredientSelect = document.getElementById('ingredient-select');
            const selectedOption = ingredientSelect.options[ingredientSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Please select an ingredient first');
                return;
            }
            
            const ingredientName = selectedOption.value;
            const purchasePrice = selectedOption.dataset.price || 0;
            const packageWeight = selectedOption.dataset.weight || 0;
            
            const existingRows = document.querySelectorAll('#selected-ingredients tbody tr');
            for (let row of existingRows) {
                if (row.cells[0].textContent === ingredientName) {
                    alert('This ingredient is already in your recipe');
                    return;
                }
            }
            
            const perGramPrice = packageWeight > 0 && purchasePrice > 0 ? (purchasePrice / packageWeight).toFixed(4) : 0;
            
            const tbody = document.querySelector('#selected-ingredients tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${ingredientName}</td>
                <td><input type="number" value="${purchasePrice}" class="price-input"></td>
                <td><input type="number" value="${packageWeight}" class="weight-input"></td>
                <td class="per-gram-price">${perGramPrice}</td>
                <td><input type="number" class="required-weight" placeholder="Enter weight in grams" value="100"></td>
                <td class="ingredient-cost">PKR ${(perGramPrice * 100).toFixed(2)}</td>
                <td><button class="delete-btn">×</button></td>
            `;
            
            tbody.appendChild(newRow);
            
            const priceInput = newRow.querySelector('.price-input');
            const weightInput = newRow.querySelector('.weight-input');
            const requiredWeightInput = newRow.querySelector('.required-weight');
            const deleteBtn = newRow.querySelector('.delete-btn');
            
            priceInput.addEventListener('input', function() {
                updatePerGramPrice.call(this);
                calculateCosts();
            });
            weightInput.addEventListener('input', function() {
                updatePerGramPrice.call(this);
                calculateCosts();
            });
            requiredWeightInput.addEventListener('input', function() {
                updateIngredientCost.call(this);
                calculateCosts();
            });
            deleteBtn.addEventListener('click', function() {
                newRow.remove();
                calculateCosts();
            });
            
            ingredientSelect.selectedIndex = 0;
            calculateCosts();
        }

        // Update per gram price when price or package weight changes
        function updatePerGramPrice() {
            const row = this.closest('tr');
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const weight = parseFloat(row.querySelector('.weight-input').value) || 0;
            const perGramCell = row.querySelector('.per-gram-price');
            
            if (weight > 0 && price > 0) {
                const perGramPrice = (price / weight).toFixed(4);
                perGramCell.textContent = perGramPrice;
            } else {
                perGramCell.textContent = '0';
            }
            
            const requiredWeightInput = row.querySelector('.required-weight');
            if (requiredWeightInput.value) {
                updateIngredientCost.call(requiredWeightInput);
            }
        }

        // Update ingredient cost when required weight changes
        function updateIngredientCost() {
            const row = this.closest('tr');
            const perGramPrice = parseFloat(row.querySelector('.per-gram-price').textContent) || 0;
            const requiredWeight = parseFloat(this.value) || 0;
            const costCell = row.querySelector('.ingredient-cost');
            
            const cost = perGramPrice * requiredWeight;
            costCell.textContent = `PKR ${cost.toFixed(2)}`;
        }

        // Calculate all costs automatically
        function calculateCosts() {
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            let totalCost = 0;
            let totalWeight = 0;
            
            rows.forEach(row => {
                const cost = parseFloat(row.querySelector('.ingredient-cost').textContent.replace('PKR ', '')) || 0;
                const weight = parseFloat(row.querySelector('.required-weight').value) || 0;
                
                totalCost += cost;
                totalWeight += weight;
            });
            
            document.getElementById('total-cost').textContent = `PKR ${totalCost.toFixed(2)}`;
            
            const perGramCost = totalWeight > 0 ? totalCost / totalWeight : 0;
            document.getElementById('per-gram-cost').textContent = `PKR ${perGramCost.toFixed(4)}`;
            
            const servingGrams = parseFloat(document.getElementById('serving-grams').value) || 0;
            const perServingCost = servingGrams > 0 ? perGramCost * servingGrams : 0;
            document.getElementById('per-serving-cost').textContent = `PKR ${perServingCost.toFixed(2)}`;
            
            const marginPercentage = parseFloat(document.getElementById('margin-percentage').value) || 0;
            const sellingPrice = perServingCost * (1 + marginPercentage / 100);
            const profitPerServing = sellingPrice - perServingCost;
            
            document.getElementById('selling-price').textContent = `PKR ${sellingPrice.toFixed(2)}`;
            document.getElementById('profit-per-serving').textContent = `PKR ${profitPerServing.toFixed(2)}`;
            
            updateWeightSummary(totalWeight, servingGrams);
            updateCharts();
        }

        // Update weight summary
        function updateWeightSummary(totalWeight, servingGrams) {
            document.getElementById('total-recipe-weight').textContent = `${totalWeight.toFixed(0)} g`;
            
            const numberOfServings = servingGrams > 0 ? Math.floor(totalWeight / servingGrams) : 0;
            const weightPerServing = numberOfServings > 0 ? (totalWeight / numberOfServings).toFixed(1) : 0;
            
            document.getElementById('number-of-servings').textContent = numberOfServings;
            document.getElementById('weight-per-serving').textContent = `${weightPerServing} g`;
        }

        // Initialize charts
        function initializeCharts() {
            const costCtx = document.getElementById('cost-breakdown-chart').getContext('2d');
            const weightCtx = document.getElementById('weight-breakdown-chart').getContext('2d');
            
            window.costChart = new Chart(costCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost Breakdown by Ingredient (PKR)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            window.weightChart = new Chart(weightCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight Breakdown by Ingredient (g)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            const costLabels = [];
            const costData = [];
            const weightLabels = [];
            const weightData = [];
            
            rows.forEach(row => {
                const name = row.cells[0].textContent;
                const cost = parseFloat(row.querySelector('.ingredient-cost').textContent.replace('PKR ', '')) || 0;
                const weight = parseFloat(row.querySelector('.required-weight').value) || 0;
                
                if (cost > 0) {
                    costLabels.push(name);
                    costData.push(cost);
                }
                
                if (weight > 0) {
                    weightLabels.push(name);
                    weightData.push(weight);
                }
            });
            
            window.costChart.data.labels = costLabels;
            window.costChart.data.datasets[0].data = costData;
            window.costChart.update();
            
            window.weightChart.data.labels = weightLabels;
            window.weightChart.data.datasets[0].data = weightData;
            window.weightChart.update();
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const recipeName = document.getElementById('recipe-name').value || 'Unnamed Recipe';
            doc.setFontSize(20);
            doc.text(recipeName, 20, 20);
            
            const servingGrams = document.getElementById('serving-grams').value || 'N/A';
            doc.setFontSize(12);
            doc.text(`Serving Size: ${servingGrams} grams`, 20, 35);
            
            const totalWeight = document.getElementById('total-recipe-weight').textContent;
            doc.text(`Total Recipe Weight: ${totalWeight}`, 20, 45);
            
            doc.text('Ingredients:', 20, 60);
            let yPosition = 70;
            
            const rows = document.querySelectorAll('#selected-ingredients tbody tr');
            rows.forEach((row, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const name = row.cells[0].textContent;
                const price = row.querySelector('.price-input').value;
                const pkgWeight = row.querySelector('.weight-input').value;
                const perGram = row.querySelector('.per-gram-price').textContent;
                const reqWeight = row.querySelector('.required-weight').value;
                const cost = row.querySelector('.ingredient-cost').textContent;
                
                doc.text(`${index + 1}. ${name}`, 20, yPosition);
                doc.text(`Purchase Price: PKR ${price} | Package: ${pkgWeight}g | Per Gram: PKR ${perGram}`, 30, yPosition + 5);
                doc.text(`Required: ${reqWeight}g | Cost: ${cost}`, 30, yPosition + 10);
                
                yPosition += 20;
            });
            
            yPosition += 10;
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.text('Cost Summary:', 20, yPosition);
            yPosition += 10;
            
            const totalCost = document.getElementById('total-cost').textContent;
            const perGramCost = document.getElementById('per-gram-cost').textContent;
            const perServingCost = document.getElementById('per-serving-cost').textContent;
            const sellingPrice = document.getElementById('selling-price').textContent;
            const profit = document.getElementById('profit-per-serving').textContent;
            
            doc.text(`Total Recipe Cost: ${totalCost}`, 30, yPosition);
            doc.text(`Cost Per Gram: ${perGramCost}`, 30, yPosition + 5);
            doc.text(`Cost Per Serving: ${perServingCost}`, 30, yPosition + 10);
            doc.text(`Selling Price: ${sellingPrice}`, 30, yPosition + 15);
            doc.text(`Profit Per Serving: ${profit}`, 30, yPosition + 20);
            
            doc.save(`${recipeName.replace(/\s+/g, '_')}_cost_analysis.pdf`);
        }
    </script>
</body>
</html>
